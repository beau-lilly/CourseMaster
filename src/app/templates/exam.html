{% extends "layout.html" %}

{% block content %}

    <a href="{{ url_for('view_course', course_id=course.course_id) }}">&larr; Back to {{ course.name }}</a>
    <h2>{{ exam.name }}</h2>
    <p class="muted">Course: {{ course.name }}</p>

    {% set flashes = get_flashed_messages(with_categories=True) %}

    <section>
        <h3>Documents in this exam</h3>
        {% if exam_documents %}
            <ul>
                {% for doc in exam_documents %}
                    <li>{{ doc.original_filename }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No documents attached yet.</p>
        {% endif %}
    </section>

    <section>
        <h4>Attach existing course documents</h4>
        {% if attachable_docs %}
            <form action="{{ url_for('attach_documents', course_id=course.course_id, exam_id=exam.exam_id) }}" method="POST">
                {% for doc in attachable_docs %}
                    <label>
                        <input type="checkbox" name="doc_ids" value="{{ doc.doc_id }}">
                        {{ doc.original_filename }}
                    </label><br>
                {% endfor %}
                <button type="submit">Attach selected</button>
            </form>
        {% else %}
            <p>No additional course documents to attach.</p>
        {% endif %}
    </section>

    <section>
        <h4>Upload a new document</h4>
        {% if flashes %}
            <div class="grid" aria-live="polite">
                {% for category, message in flashes %}
                    <article class="{{ 'secondary' if category == 'warning' else 'success' }}">{{ message }}</article>
                {% endfor %}
            </div>
        {% endif %}
        <form action="{{ url_for('upload_exam_document', course_id=course.course_id, exam_id=exam.exam_id) }}" method="POST" enctype="multipart/form-data">
            <label for="document">
                Choose file
                <input type="file" id="document" name="document" required>
            </label>
            <button type="submit">Upload to exam</button>
        </form>
        <p class="muted">Documents uploaded here are also added to the course library.</p>
    </section>

    <section>
        <h3>Retrieval overview</h3>
        <form method="get" action="{{ url_for('view_exam', course_id=course.course_id, exam_id=exam.exam_id) }}">
            <div class="grid">
                <label>
                    Show
                    <select name="display">
                        <option value="chunks" {% if display_mode == 'chunks' %}selected{% endif %}>Chunks</option>
                        <option value="documents" {% if display_mode == 'documents' %}selected{% endif %}>Documents</option>
                    </select>
                </label>
                <label>
                    Ranking order
                    <select name="ranking">
                        {% for key, label in ranking_options.items() %}
                            <option value="{{ key }}" {% if ranking_strategy == key %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label>
                    Top K
                    <input type="number" name="limit" min="1" step="1" value="{{ ranking_limit }}">
                </label>
            </div>
            <button type="submit">Update view</button>
        </form>

        {% if display_mode == 'chunks' %}
            {% if top_chunks %}
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Source</th>
                            <th>Chunk</th>
                            <th>{% if ranking_is_frequency %}Frequency{% else %}Score{% endif %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for chunk in top_chunks %}
                            <tr>
                                <td>{{ chunk.rank }}</td>
                                <td>{{ chunk.doc_name }} (Chunk {{ chunk.chunk_index }})</td>
                                <td>{{ chunk.chunk_text[:200] }}{% if chunk.chunk_text|length > 200 %}â€¦{% endif %}</td>
                                <td>
                                    {% if ranking_is_frequency %}
                                        {{ chunk.score_display or chunk.score }}
                                    {% else %}
                                        {{ '%.3f'|format(chunk.score) }}
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="muted">No retrievals logged for this exam yet.</p>
            {% endif %}
        {% else %}
            {% if top_documents %}
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Document</th>
                            <th>{% if ranking_is_frequency %}Frequency{% else %}Score{% endif %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doc in top_documents %}
                            <tr>
                                <td>{{ doc.rank }}</td>
                                <td>{{ doc.filename }}</td>
                                <td>
                                    {% if ranking_is_frequency %}
                                        {{ doc.score_display or doc.score }}
                                    {% else %}
                                        {{ '%.3f'|format(doc.score) }}
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="muted">No document retrievals to rank yet.</p>
            {% endif %}
        {% endif %}
    </section>

    <section>
        <h3>Problems</h3>
        {% if problems %}
            <ul>
                {% for problem in problems %}
                    {% set assignment = assignment_lookup.get(problem.assignment_id) %}
                    <li>
                        <a href="{{ url_for('view_problem', course_id=course.course_id, exam_id=exam.exam_id, problem_id=problem.problem_id) }}">
                            {{ assignment.name if assignment else "Unassigned" }}
                            {% if problem.problem_number is not none %} #{{ problem.problem_number }}{% endif %}
                        </a>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No problems have been added yet.</p>
        {% endif %}
    </section>

    <section>
        <h4>Add a problem</h4>
        <form action="{{ url_for('create_problem', course_id=course.course_id, exam_id=exam.exam_id) }}" method="POST">
            <label for="assignment_id">Select existing assignment</label>
            <select id="assignment_id" name="assignment_id">
                <option value="">-- New assignment --</option>
                {% for assignment in assignments %}
                    <option value="{{ assignment.assignment_id }}">{{ assignment.name }}</option>
                {% endfor %}
            </select>

            <label for="new_assignment_name">Or create a new assignment</label>
            <input type="text" id="new_assignment_name" name="new_assignment_name" placeholder="e.g., Homework 1">

            <label for="problem_number">Problem number (optional)</label>
            <input type="number" id="problem_number" name="problem_number" min="1" step="1">

            <label for="problem_text">Problem text</label>
            <textarea id="problem_text" name="problem_text" rows="4" required></textarea>

            <button type="submit">Create problem</button>
        </form>
    </section>

{% endblock %}
